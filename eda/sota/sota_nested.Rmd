---
title: Examine nested SOTA data
author: 
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)

# Parameters
file_sota <- here::here("data/sota/sota_nested.rds")
#===============================================================================

sota <- read_rds(file_sota)
```

## What does each row represent?

One paper can have multiple rows.

```{r}
sota %>% 
  count(paper_id, benchmark_id, sort = TRUE)
```

One paper/model combo can also have multiple rows.

```{r}
sota %>% 
  count(paper_id, model_name, sort = TRUE)
```

Each row represents a paper-metric combination.  

```{r}
sota %>% 
  select(index, paper_id, metric_name) %>% 
  unnest(cols = metric_name) %>% 
  count(paper_id, metric_name, sort = TRUE)
```

## Missing values

```{r}
sota %>% 
  transmute_at(vars(benchmark_id, task), is.na) %>% 
  count(!!! .)
```

All rows have a benchmark ID and task

```{r}
sota %>% 
  transmute_at(
    vars(metric_name, metric_result), 
    ~ map_lgl(., ~ is_empty(.))
  ) %>% 
  count(!!! ., sort = TRUE)
```

There are 509 rows that are missing a `metric_name` and a `metric_result`.

```{r}
sota %>% 
  select(index, paper_id, metrics) %>% 
  unnest(cols = metrics) %>% 
  transmute_at(vars(metric, value), is.na) %>% 
  count(!!! .)
```

## Metrics

Are all metrics in the metrics tibble in the `metric_name` and `metric_result` columns?

```{r}
metrics_tibble_unnested <-
  sota %>% 
  select(index, paper_id, metrics) %>% 
  unnest(cols = metrics) %>% 
  distinct(paper_id, metric, value) %>% 
  filter(!is.na(metric), !is.na(value)) %>% 
  arrange(paper_id, metric)

metrics_lists_unnested <-
  sota %>% 
  select(paper_id, metric_name, metric_result) %>% 
  unnest(
    cols = c(metric_name, metric_result)
  ) %>% 
  rename(metric = metric_name, value = metric_result) %>% 
  arrange(paper_id, metric)

compare::compare(
  metrics_tibble_unnested, 
  metrics_lists_unnested
)
```

The number of paper-metric combinations is the same. The metrics in the list columns of vectors (`metric_name` and `metric_result`) look like they are cleaned up. They don't have percentage signs, and some of the numbers are converted from percentages to proportions. 

Is every value in `metric_name` and `metric_result` a character vector of length 1?

```{r}
sota %>% 
  transmute_at(vars(metric_name, metric_result), ~ map_int(., length)) %>% 
  count(!!! .)
```

They are all either empty or length 1.

How many papers have no metrics?

```{r}
number_of_metrics <-
  sota %>% 
  select(paper_id, metric_name, metric_result) %>% 
  unnest(cols = c(metric_name, metric_result), keep_empty = TRUE) %>% 
  group_by(paper_id) %>% 
  summarize(n_metrics = n_distinct(metric_name, na.rm = TRUE)) %>% 
  count(n_metrics, sort = TRUE)
```

There are 509 papers without a metric. 

```{r}
number_of_metrics %>% 
  ggplot(aes(n_metrics, weight = n)) +
  geom_bar() +
  scale_x_continuous(breaks = scales::breaks_width(1)) +
  labs(x = "Number of metrics per paper")
```

## Benchmarks

```{r}
sota %>% 
  count(benchmark_id, sort = TRUE)
```

## Categories

```{r}
sota %>% 
  mutate(n_categories = map_int(categories, length)) %>% 
  count(n_categories, sort = TRUE)
```


## Tasks

```{r}
sota %>% 
  count(task, sort = TRUE)
```

## Benchmarks

```{r}
sota %>% 
  count(benchmark_id, sort = TRUE)
```


## Metrics

Just look a speech recognition. Do they all have the same metric?

```{r}
speech_recognition <-
  sota %>% 
  filter(task == "Speech Recognition") %>% 
  select(paper_id, model_name, paper_date, metrics) %>% 
  unnest(cols = metrics)

speech_recognition %>% 
  ggplot(aes(paper_date, value)) +
  geom_point()
```

